# =============================================================================
# KubeAgentiX Debug - Container Image Build & Release
# =============================================================================
# This workflow builds multi-architecture container images and publishes them
# to GitHub Container Registry (ghcr.io) with cryptographic signatures.
#
# Security Features:
# - Reproducible builds using SOURCE_DATE_EPOCH
# - Cosign keyless signing for supply chain security
# - SBOM generation and attestation
# - Multi-architecture support (amd64, arm64)
# =============================================================================

name: Release Container Images

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  build-and-release:
    name: Build & Publish to GHCR
    runs-on: ubuntu-latest

    permissions:
      contents: write       # Create releases
      packages: write       # Push to GHCR
      id-token: write       # Keyless signing with cosign
      attestations: write   # For SBOM attestations

    outputs:
      image: ${{ steps.meta.outputs.tags }}
      digest: ${{ steps.build.outputs.digest }}

    steps:
      # -----------------------------------------------------------------------
      # Setup
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.4.0

      - name: Install Syft (SBOM generator)
        uses: anchore/sbom-action/download-syft@v0

      # -----------------------------------------------------------------------
      # Authentication
      # -----------------------------------------------------------------------
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # Extract Metadata
      # -----------------------------------------------------------------------
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Extract build info
        id: build-info
        run: |
          # Get version from tag or input
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi

          SOURCE_DATE_EPOCH=$(git log -1 --pretty=%ct)
          BUILD_DATE=$(date -u -d "@${SOURCE_DATE_EPOCH}" '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -u '+%Y-%m-%dT%H:%M:%SZ')

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_short=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "commit=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "commit_short=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "source_date_epoch=${SOURCE_DATE_EPOCH}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------------------
      # Build and Push to GHCR
      # -----------------------------------------------------------------------
      - name: Build and push to GHCR
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            SOURCE_DATE_EPOCH=${{ steps.build-info.outputs.source_date_epoch }}
            VERSION=${{ steps.build-info.outputs.version_short }}
            COMMIT=${{ steps.build-info.outputs.commit }}
            BUILD_DATE=${{ steps.build-info.outputs.build_date }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      # -----------------------------------------------------------------------
      # Sign Container Image with Cosign
      # -----------------------------------------------------------------------
      - name: Sign container image
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          images=""
          for tag in ${TAGS}; do
            images+="${tag}@${DIGEST} "
          done
          cosign sign --yes ${images}

      # -----------------------------------------------------------------------
      # Generate and Attach SBOM
      # -----------------------------------------------------------------------
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
          artifact-name: sbom.spdx.json
          output-file: ./sbom.spdx.json

      - name: Attest SBOM
        run: |
          cosign attest --yes --predicate ./sbom.spdx.json \
            --type spdxjson \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}

      # -----------------------------------------------------------------------
      # Create GitHub Release
      # -----------------------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: KubeAgentiX Debug ${{ steps.build-info.outputs.version }}
          tag_name: ${{ steps.build-info.outputs.version }}
          draft: false
          prerelease: false
          files: |
            ./sbom.spdx.json
          body: |
            ## KubeAgentiX Debug ${{ steps.build-info.outputs.version }}

            A secure, ephemeral, policy-aware Kubernetes debugging runtime.

            ### ðŸ³ Pull from GitHub Container Registry

            ```bash
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.build-info.outputs.version_short }}
            ```

            Or use the latest:

            ```bash
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ```

            ### ðŸ” Security Features
            - âœ… Non-root user (UID 65532)
            - âœ… Pod Security Standards "restricted" compatible
            - âœ… No SUID/SGID binaries
            - âœ… Minimal Alpine base (~59MB)
            - âœ… Cosign-signed image
            - âœ… SBOM attestation attached

            ### ðŸ–¥ï¸ Supported Platforms
            - `linux/amd64`
            - `linux/arm64`

            ### ðŸš€ Quick Start

            ```bash
            # Use with kubectl debug
            kubectl debug mypod -it --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.build-info.outputs.version_short }}

            # Or as ephemeral container targeting specific container
            kubectl debug mypod -it \
              --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.build-info.outputs.version_short }} \
              --target=mycontainer
            ```

            ### âœ… Verify Image Signature

            ```bash
            cosign verify ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.build-info.outputs.version_short }} \
              --certificate-oidc-issuer https://token.actions.githubusercontent.com \
              --certificate-identity-regexp="https://github.com/${{ github.repository }}"
            ```

            ### ðŸ“‹ Verify SBOM Attestation

            ```bash
            cosign verify-attestation ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.build-info.outputs.version_short }} \
              --type spdxjson \
              --certificate-oidc-issuer https://token.actions.githubusercontent.com \
              --certificate-identity-regexp="https://github.com/${{ github.repository }}"
            ```

            ### ðŸ“¦ Build Information
            - **Image:** `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.build-info.outputs.version_short }}`
            - **Digest:** `${{ steps.build.outputs.digest }}`
            - **Commit:** `${{ steps.build-info.outputs.commit }}`
            - **Build Date:** `${{ steps.build-info.outputs.build_date }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # Summary
      # -----------------------------------------------------------------------
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Container Image" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.build-info.outputs.version_short }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Digest" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.build-info.outputs.version_short }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
